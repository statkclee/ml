---
layout: page
title: xwMOOC 기계학습
subtitle: "단변량/다변량 이상점 검출 - 사기 탐지"
author:
    name: xwMOOC
    url: https://www.facebook.com/groups/tidyverse/
    affiliation: Tidyverse Korea
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    toc_float: true
    highlight: tango
    code_folding: show
    number_section: true
    self_contained: true
editor_options: 
  chunk_output_type: console
---


``` {r, include=FALSE}
# source("tools/chunk-options.R")
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      comment="", digits = 3, tidy = FALSE, prompt = FALSE, fig.align = 'center')

```

# 이상점 탐지 방법론 [^outlier-detection-techniques] {#outlier-detection-techniques}

[^outlier-detection-techniques]: [Outlier Detection Techniques](http://www.dbs.ifi.lmu.de/~zimek/publications/KDD2010/kdd10-outlier-tutorial.pdf)

이상점 탐지 기법을 통해 사기탐지(fraud detection)에도 응용이 가능하다. [Outlier Detection Techniques](http://www.dbs.ifi.lmu.de/~zimek/publications/KDD2010/kdd10-outlier-tutorial.pdf) 발표자료에 의하면 정말 다양한 이상점 탐지 방법이 제시되고 있다.

- 모형기반 (Model-based) 
    - 통계검증 (Statistical Tests)
    - 깊이 기반 접근법(Depth-based Approaches)
    - 편차 기반 접근법(Deviation-based Approaches)
- 근접기반 (Proximity-based)
    - 거리 기반(Distance-based Approaches)
    - 밀도 기반(Density-based Approaches)
- 고차원 접근법 (High dimensional Approaches)


# 마할라노비스 거리 맛보기 [^outlier-mahalanobis-distance] [^outlier-mahalanobis] {#mahalanobis-distance-overview}

> "It is perfect to use both classical and robust methods routinely, and only worry
> when they differ enough to matter... But when they differ, you should think hard."
> **J.W. Tukey (1979)**


[^outlier-mahalanobis-distance]: [Outlier Detection with Mahalanobis Distance](https://www.steffenruefer.com/2016/12/outlier-detection-with-mahalanobis-distance/)
[^outlier-mahalanobis]: [Using Mahalanobis Distance to Find Outliers](https://eurekastatistics.com/using-mahalanobis-distance-to-find-outliers/)

다차원 공간에서 이상점을 찾아내는 간단한 방법이 [마할라노비스 거리](https://en.wikipedia.org/wiki/Mahalanobis_distance)를 활용하는 것이다.
유클리디안 거리를 다차원 공간으로 확장한 것으로 생각하면 쉽게 이해할 수 있다.

평균 $\vec{\mu} = ( \mu_1, \mu_2, \mu_3, \dots , \mu_N )^T$와 공분산 $S$를 갖는 벡터 $\vec{x} = ( x_1, x_2, x_3, \dots, x_N )^T$에 대한  
마할라노비스 거리에 대한 수학적 정의는 다음과 같다.

$D_M(\vec{x}) = \sqrt{(\vec{x} - \vec{\mu})^T S^{-1} (\vec{x}-\vec{\mu})}$

## 신장과 체중 {#mahalanobis-distance-data}

``` {r mahalanobis-ex}
library(tidyverse)

# 신장과 체중 데이터 
df <- data.frame(height_cm=c(164, 167, 168, 169, 169, 170, 170, 170, 171, 172, 172, 173, 173, 175, 176, 178),
                 weight_kg=c( 54,  57,  58,  60,  61,  60,  61,  62,  62,  64,  62,  62,  64,  56,  66,  70))


# 신장과 체중 분포에 대한 마할라노비스 거리 계산
m_dist <- mahalanobis(df[, 1:2], colMeans(df[, 1:2]), cov(df[, 1:2]))
df$m_dist <- round(m_dist, 2)

# 마할라노비스 이상점 - 임계점을 12로 설정
df$outlier_maha <- "No"
df$outlier_maha[df$m_dist > 12] <- "Yes"

# 시각화
ggplot(df, aes(x = weight_kg, y = height_cm, color = outlier_maha)) +
    geom_point(size = 5, alpha = 0.6) +
    labs(title = "신장과 체중",
         subtitle = "마할라노비스 거리를 활용하여 신장과 체중 이상점 검출",
         caption = "Source: https://www.steffenruefer.com/2016/12/outlier-detection-with-mahalanobis-distance/ \n
                            https://eurekastatistics.com/using-mahalanobis-distance-to-find-outliers/") +
    ylab("신장(cm)") + xlab("체중(kg)") +
    scale_y_continuous(breaks = seq(160, 200, 5)) +
    scale_x_continuous(breaks = seq(35, 80, 5)) +
    theme_minimal(base_family = "NanumGothic")
```

## 마할라노비스 거리 적용시 주의점 {#mahalanobis-distance-caveat}

마할라노비스 거리를 활용하여 이상점을 추출할 수 있으나 선형적인 관계가 존재할 때 유용하고 비선형인 경우 이상점을 잘못 검출할 수 있다.


``` {r mahalanobis-caveats}
# 주의점 ------------------------------------------------------------------

caveats_df <- data.frame(x=c(4,  8, 10, 16, 17, 22, 27, 33, 38, 40, 47, 48, 53, 55, 63, 71, 76, 85, 85, 92, 96),
                         y=c(6, 22, 32, 34, 42, 51, 59, 63, 64, 69, 70, 20, 70, 63, 63, 55, 46, 41, 33, 19,  6))

caveats_dist <- mahalanobis(caveats_df[, 1:2], colMeans(caveats_df[, 1:2]), cov(caveats_df[, 1:2]))
caveats_df$m_dist <- round(caveats_dist, 2)

# Mahalanobis Outliers - Threshold set to 12
caveats_df$outlier_maha <- "No"
caveats_df$outlier_maha[caveats_df$m_dist > 5] <- "Yes"

ggplot(caveats_df, aes(x = x, y = y, color = outlier_maha)) +
    geom_point(size = 5, alpha = 0.6) +
    labs(title = "마할라노비스 거리 사용시 주의점",
         subtitle = "비선형 관계일 경우 주의 요망 !!!",
         caption = "Source: https://eurekastatistics.com/using-mahalanobis-distance-to-find-outliers/") +
    ylab("신장(cm)") + xlab("체중(kg)") +
    theme_minimal(base_family = "NanumGothic")
```


# 기술 통계량 {#outlier-descriptive-stats}

```{r outlier-descriptive-stats}
library(readxl)
library(tidyverse)

inc_2016_dat <- read_excel("data/근로소득천분위.xlsx", sheet="2016", skip=3) 
inc_2015_dat <- read_excel("data/근로소득천분위.xlsx", sheet="2015", skip=3) 
inc_2014_dat <- read_excel("data/근로소득천분위.xlsx", sheet="2014", skip=3) 
inc_2013_dat <- read_excel("data/근로소득천분위.xlsx", sheet="2013", skip=3) 

inc_2016_df <- inc_2016_dat %>%
  filter(`구분` != "합계") %>% 
  mutate(`백분위` = 100 - parse_number(`구분`) %>% ntile(100)) %>% 
  group_by(`백분위`) %>% 
  summarise(`총급여합` = sum(`총급여`)) %>% 
  mutate(`연도` = 2016)

inc_2015_df <- inc_2015_dat %>%
  filter(`구분` != "합계") %>% 
  mutate(`백분위` = 100 - parse_number(`구분`) %>% ntile(100)) %>% 
  group_by(`백분위`) %>% 
  summarise(`총급여합` = sum(`총급여`)) %>% 
  mutate(`연도` = 2015)

inc_2014_df <- inc_2014_dat %>%
  filter(`구분` != "합계") %>% 
  mutate(`백분위` = 100 - parse_number(`구분`) %>% ntile(100)) %>% 
  group_by(`백분위`) %>% 
  summarise(`총급여합` = sum(`총급여`)) %>% 
  mutate(`연도` = 2014)

inc_2013_df <- inc_2013_dat %>%
  filter(`구분` != "합계") %>% 
  mutate(`백분위` = 100 - parse_number(`구분`) %>% ntile(100)) %>% 
  group_by(`백분위`) %>% 
  summarise(`총급여합` = sum(`총급여`)) %>% 
  mutate(`연도` = 2013)

inc_df <- bind_rows(inc_2013_df, inc_2014_df) %>% 
  bind_rows(inc_2015_df) %>% 
  bind_rows(inc_2016_df)

  
inc_df %>% 
  ggplot(aes(x=`백분위`, y=`총급여합`, color=as.factor(`연도`))) +
    geom_point() +
    geom_line() +
    coord_flip() +
    scale_y_continuous(labels=scales::comma) +
    # scale_x_continuous(limits=c(0,30)) +
    # coord_cartesian(xlim = c(0, 20), ylim=c(0,25000)) +
    coord_cartesian(xlim = c(90, 100), ylim=c(100000, 450000))
    
inc_2016_dat %>% 
  filter(`구분` != "합계") %>% 
  ggplot(aes(x=`총급여`)) +
    geom_density() +
        scale_y_sqrt(labels=scales::comma)

inc_2016_dat %>% 
  filter(`구분` != "합계") %>% 
  ggplot(aes(x=`총급여`)) +
    geom_histogram() +
        scale_y_sqrt(labels=scales::comma)


```

